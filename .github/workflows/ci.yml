on: [push, pull_request]

jobs:
  build-js:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install npm modules
        run: npm clean-install
      - name: Build frontend assets
        run: npm run prod
  lint-js:
    runs-on: ubuntu-latest
    needs: build-js
    steps:
      - run: make eslint || echo "Running in $(pwd)"; ls -lAh

  test_php:
    name: Test PHP
    runs-on: ${{ matrix.os }}
    env:
      RUN_MODE: php
      CI_PHP_VERSION: ${{ matrix.php }}
    strategy:
      matrix:
        os: [ubuntu-18.04, windows-2019]
        php: ['7.4', '8.0']
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup PHP Environment
      uses: nanasess/setup-php@master
      with:
        php-version: ${{ matrix.php }}
    - name: Install application
      run: .github/scripts/install.sh
    - name: Prepare permissions
      run: .github/scripts/prepare.sh
    - name: Lint and Test
      run: .github/scripts/script.sh
    - name: Ping codecov.io
      run: bash <(curl -s https://codecov.io/bash)
    - name: Print Laravel logs on failure
      if: failure()
      run: cat storage/logs/laravel.log
